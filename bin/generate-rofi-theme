#!/bin/bash

# Generate rofi theme from current Hyprland theme colors
# Extracts colors from theme's ghostty.conf or alacritty.toml

THEME_DIR="$HOME/.config/hypr/current/theme"
ROFI_CONFIG="$HOME/.config/rofi/config.rasi"

# Default colors (fallback)
BG_COL="#1e1e2e"
BG_LIGHT="#28283a"
FG_COL="#cdd6f4"
ACCENT="#89b4fa"
BORDER="#89b4fa"

# Try to extract colors from ghostty.conf
if [[ -f "$THEME_DIR/ghostty.conf" ]]; then
  # Extract background and foreground
  BG_COL=$(grep "^background" "$THEME_DIR/ghostty.conf" | head -1 | awk '{print $2}' | tr -d '=')
  FG_COL=$(grep "^foreground" "$THEME_DIR/ghostty.conf" | head -1 | awk '{print $2}' | tr -d '=')
  
  # Validate colors (must start with #)
  [[ ! "$BG_COL" =~ ^# ]] && BG_COL="#1e1e2e"
  [[ ! "$FG_COL" =~ ^# ]] && FG_COL="#cdd6f4"
  
  # Extract accent color (use blue from palette, or cyan as fallback)
  ACCENT=$(grep "^palette = 4=" "$THEME_DIR/ghostty.conf" | head -1 | awk -F'=' '{print $3}' | tr -d ' ')
  if [[ -z "$ACCENT" ]] || [[ ! "$ACCENT" =~ ^# ]]; then
    ACCENT=$(grep "^palette = 6=" "$THEME_DIR/ghostty.conf" | head -1 | awk -F'=' '{print $3}' | tr -d ' ')
  fi
  [[ ! "$ACCENT" =~ ^# ]] && ACCENT="#89b4fa"
  
  # Use border color as accent if available
  BORDER="$ACCENT"
  
  # Calculate lighter background
  if command -v python3 &> /dev/null; then
    BG_LIGHT=$(python3 -c "
import colorsys
hex_color = '$BG_COL'.lstrip('#')
rgb = tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
hsv = colorsys.rgb_to_hsv(rgb[0]/255.0, rgb[1]/255.0, rgb[2]/255.0)
# Increase brightness by 10%
new_hsv = (hsv[0], hsv[1], min(1.0, hsv[2] + 0.1))
new_rgb = colorsys.hsv_to_rgb(*new_hsv)
print('#{:02x}{:02x}{:02x}'.format(int(new_rgb[0]*255), int(new_rgb[1]*255), int(new_rgb[2]*255)))
" 2>/dev/null || echo "$BG_LIGHT")
  fi
fi

# Try alacritty.toml as fallback
if [[ "$BG_COL" == "#1e1e2e" ]] && [[ -f "$THEME_DIR/alacritty.toml" ]]; then
  BG_COL=$(grep "background" "$THEME_DIR/alacritty.toml" | head -1 | awk -F'"' '{print $2}')
  FG_COL=$(grep "foreground" "$THEME_DIR/alacritty.toml" | head -1 | awk -F'"' '{print $2}')
  ACCENT=$(grep "blue" "$THEME_DIR/alacritty.toml" | head -1 | awk -F'"' '{print $2}')
  
  # Validate colors
  [[ ! "$BG_COL" =~ ^# ]] && BG_COL="#1e1e2e"
  [[ ! "$FG_COL" =~ ^# ]] && FG_COL="#cdd6f4"
  [[ ! "$ACCENT" =~ ^# ]] && ACCENT="#89b4fa"
  
  BORDER="$ACCENT"
fi

# Ensure all colors are valid (must start with # and be valid hex)
# Remove any whitespace and ensure proper format
BG_COL=$(echo "$BG_COL" | tr -d '[:space:]')
BG_LIGHT=$(echo "$BG_LIGHT" | tr -d '[:space:]')
FG_COL=$(echo "$FG_COL" | tr -d '[:space:]')
ACCENT=$(echo "$ACCENT" | tr -d '[:space:]')
BORDER=$(echo "$BORDER" | tr -d '[:space:]')

[[ ! "$BG_COL" =~ ^#[0-9A-Fa-f]{6}$ ]] && BG_COL="#1e1e2e"
[[ ! "$BG_LIGHT" =~ ^#[0-9A-Fa-f]{6}$ ]] && BG_LIGHT="#28283a"
[[ ! "$FG_COL" =~ ^#[0-9A-Fa-f]{6}$ ]] && FG_COL="#cdd6f4"
[[ ! "$ACCENT" =~ ^#[0-9A-Fa-f]{6}$ ]] && ACCENT="#89b4fa"
[[ ! "$BORDER" =~ ^#[0-9A-Fa-f]{6}$ ]] && BORDER="#89b4fa"

# Generate rofi config
cat > "$ROFI_CONFIG" << EOF
/**
 * Rofi Configuration for Hyprland
 * Auto-generated from current theme
 */

configuration {
    modi: "drun,run,window";
    show-icons: true;
    terminal: "xdg-terminal-exec";
    drun-display-format: "{icon} {name}";
    location: 0;
    disable-history: false;
    hide-scrollbar: true;
    display-drun: "  Apps ";
    display-run: "  Run ";
    display-window: "  Windows ";
    sidebar-mode: true;
    font: "JetBrainsMono Nerd Font 10";
    width: 50;
    lines: 15;
    columns: 1;
    padding: 15;
    border-radius: 8;
    kb-custom-1: "1";
    kb-custom-2: "2";
    kb-custom-3: "3";
    kb-custom-4: "4";
    kb-custom-5: "5";
    kb-custom-6: "6";
    kb-custom-7: "7";
    kb-custom-8: "8";
    kb-custom-9: "9";
    kb-custom-10: "0";
    kb-accept-custom: "Control+1,Control+2,Control+3,Control+4,Control+5,Control+6,Control+7,Control+8,Control+9,Control+0";
}

* {
    bg-col:                          $BG_COL;
    bg-col-light:                    $BG_LIGHT;
    border-col:                       $BORDER;
    selected-col:                     $ACCENT;
    blue:                             $ACCENT;
    fg-col:                           $FG_COL;
    fg-col2:                          $FG_COL;
    grey:                             $FG_COL;
    width:                            600;
    font:                             "JetBrainsMono Nerd Font 10";
}

element-text, element-icon, mode-switcher {
    background-color: inherit;
    text-color:       inherit;
}

window {
    height: 360px;
    border: 2px;
    border-color: @border-col;
    background-color: @bg-col;
}

mainbox {
    background-color: @bg-col;
}

inputbar {
    children: [prompt,entry];
    background-color: @bg-col;
    border-radius: 5px;
    padding: 2px;
}

prompt {
    background-color: @blue;
    padding: 6px;
    text-color: @bg-col;
    border-radius: 3px;
    margin: 20px;
    font: "JetBrainsMono Nerd Font 10";
}

textbox-prompt-colon {
    expand: false;
    str: ":";
}

entry {
    background-color: @bg-col;
    text-color: @fg-col;
    padding: 6px;
    margin: 20px;
    text-color: @fg-col;
    border-radius: 3px;
}

listview {
    border-radius: 5px;
    margin: 0px 0px 10px 0px;
    padding: 0px 0px 0px 0px;
}

element {
    background-color: @bg-col-light;
    border-radius: 3px;
    padding: 5px;
    margin: 0px 5px 0px 5px;
}

element-icon {
    size: 30px;
}

element selected {
    background-color: @selected-col;
    text-color: @bg-col;
}

element-text {
    text-color: @fg-col;
}

element selected element-text {
    text-color: @bg-col;
}
EOF

